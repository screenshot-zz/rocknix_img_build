# .github/workflows/release.yml
# schedule refresh
name: Create Release with Image

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "æ˜¯å¦å¼ºåˆ¶å¿½ç•¥ç‰ˆæœ¬åˆ¤æ–­å¹¶æ‰§è¡Œæ„å»ºï¼Ÿ"
        required: false
        default: "false"
      manual_tag:
        description: "ï¼ˆå¯é€‰ï¼‰æ‰‹åŠ¨æ„å»ºçš„ tag åï¼ˆå¦‚ 20250722ï¼‰"
        required: false
  schedule:
    - cron: '0 1 * * *'   # æ¯å¤© 09:00 åŒ—äº¬æ—¶é—´
    - cron: '0 13 * * *'  # æ¯å¤© 21:00 åŒ—äº¬æ—¶é—´
  create:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“æ‰€æœ‰åˆ†æ”¯ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä» mod-version åˆ†æ”¯æ¢å¤ .version
        id: restore_version
        run: |
          git fetch origin mod-version || echo "ğŸ†• mod-version åˆ†æ”¯å°šä¸å­˜åœ¨"
          if git show-ref --verify --quiet refs/remotes/origin/mod-version; then
            git show origin/mod-version:.version > .version
          else
            echo "ğŸ§© å°šæœªåˆ›å»º mod-version åˆ†æ”¯ï¼Œè·³è¿‡æ¢å¤"
          fi
          
      # â†“ å¦‚æœæ˜¯é€šè¿‡â€œæ–°å»º tagâ€è§¦å‘çš„ï¼Œå°±æŠŠè¿™ä¸ªä¸´æ—¶ tag åˆ æ‰ â†“
      - name: åˆ é™¤æ‰‹åŠ¨è§¦å‘æ ‡ç­¾
        if: ${{ github.event_name == 'create' && github.ref_type == 'tag' }}
        run: |
          # ä» GITHUB_REF ä¸­å‰¥ç¦»å‡º tag å
          tag=${GITHUB_REF#refs/tags/}
          echo "ğŸ—‘ åˆ é™¤æ‰‹åŠ¨è§¦å‘ç”¨çš„æ ‡ç­¾ï¼š$tag"
          # åˆ é™¤è¿œç¨‹ tag
          git push origin --delete "refs/tags/$tag"

      - name: æ£€æµ‹å¹¶æ¯”è¾ƒç‰ˆæœ¬ï¼ˆä½¿ç”¨ mod-version åˆ†æ”¯ï¼‰
        id: detect_version
        run: |
          echo "ğŸ§ª è·å–æœ€æ–° H700 é•œåƒä¿¡æ¯..."

          git fetch origin mod-version || echo "â„¹ï¸ mod-version åˆ†æ”¯å°šæœªåˆ›å»º"
          git show origin/mod-version:.version > .version.last 2>/dev/null || echo "â„¹ï¸ æœªæ£€æµ‹åˆ°å†å²ç‰ˆæœ¬è®°å½•"

          response=$(curl -s https://api.github.com/repos/ROCKNIX/distribution-nightly/releases)
          if ! echo "$response" | jq empty >/dev/null 2>&1; then
            echo "âŒ æ— æ³•è§£æ JSON å“åº”ï¼Œç»ˆæ­¢"
            exit 1
          fi

          latest_url=$(echo "$response" | jq -r '.[0].assets[].browser_download_url' \
            | grep 'H700' | grep 'img\.gz$' | head -n1)
          if [[ -z "$latest_url" ]]; then
            echo "âŒ æœªè·å–åˆ°æœ‰æ•ˆçš„ H700 é•œåƒ URL"
            exit 1
          fi

          version=$(basename "$latest_url" | grep -oP '\d{8}')
          echo "ğŸ“¦ æœ€æ–°ç‰ˆæœ¬å·: $version"
          echo "$version" > .version
          echo "LATEST_VERSION=$version" >> $GITHUB_ENV

          if [ "${{ github.event.inputs.force_build }}" = "true" ]; then
            echo "ğŸš¨ æ‰‹åŠ¨è§¦å‘ï¼šå¿½ç•¥ç‰ˆæœ¬æ¯”è¾ƒï¼Œå¼ºåˆ¶æ„å»º"
          else
            if [ -f .version.last ]; then
              old_version=$(cat .version.last | tr -d '\r\n')
              echo "ğŸ“‚ ä¸Šæ¬¡æ„å»ºç‰ˆæœ¬: $old_version"
              if [ "$version" = "$old_version" ]; then
                echo "âœ… é•œåƒç‰ˆæœ¬æœªæ›´æ–°ï¼ˆ$versionï¼‰ï¼Œç»ˆæ­¢ Workflow."
                exit 78
              fi
            else
              echo "ğŸ†• é¦–æ¬¡æ„å»ºï¼Œæœªæ£€æµ‹åˆ° .version.last"
            fi
          fi

          if [ -n "${{ github.event.inputs.manual_tag }}" ]; then
            tag_name="${{ github.event.inputs.manual_tag }}"
            release_name="æ‰‹åŠ¨æ„å»ºç‰ˆæœ¬"
          else
            tag_name="auto-${version}"
            release_name="è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ - ${version}"
          fi

          echo "tag_name=$tag_name" >> $GITHUB_OUTPUT
          echo "release_name=$release_name" >> $GITHUB_OUTPUT

      - name: å®‰è£…ä¾èµ–é¡¹
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet jq

      - name: æ„å»º 3566 æ˜ åƒ
        run: |
          chmod +x ./build_3566_common.sh
          sudo ./build_3566_common.sh
          sudo ./build_3566_common.sh mini
          
          
      - name: æ„å»º X55 æ˜ åƒ
        run: |
          chmod +x ./build_3566_common.sh
          sudo ./build_3566_common.sh x55
          sudo ./build_3566_common.sh mini_x55
          
      - name: æ„å»º 3326 æ˜ åƒ
        run: |
          chmod +x ./build_3326_common.sh
          sudo ./build_3326_common.sh
          sudo ./build_3326_common.sh mini

      - name: æ„å»º H700 æ˜ åƒ
        run: |
          chmod +x ./build_h700_common.sh
          sudo ./build_h700_common.sh
          sudo ./build_h700_common.sh mini

      - name: æå–æ‰€æœ‰é•œåƒ
        id: extract_assets
        run: |
          echo "ğŸ” æœç´¢æ‰€æœ‰ .img.gz é•œåƒæ–‡ä»¶..."
          mapfile -t files < <(find . -type f -name '*.img.gz')
      
          if [ ${#files[@]} -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ° .img.gz é•œåƒæ–‡ä»¶ï¼"
            exit 1
          fi
      
          echo "ğŸ“¦ å…±æ‰¾åˆ° ${#files[@]} ä¸ªé•œåƒæ–‡ä»¶ï¼š"
          joined_files=""
      
          total_size_bytes=0
      
          for file in "${files[@]}"; do
            size_bytes=$(stat -c%s "$file")
            size_mb=$(awk "BEGIN {printf \"%.2f\", $size_bytes / 1024 / 1024}")
            echo " - $file (${size_mb} MB)"
            total_size_bytes=$((total_size_bytes + size_bytes))
            joined_files+="$file"$'\n'
          done
      
          total_size_mb=$(awk "BEGIN {printf \"%.2f\", $total_size_bytes / 1024 / 1024}")
          echo "ğŸ“Š é•œåƒæ€»å¤§å°: ${total_size_mb} MB"
      
          echo "ASSET_PATHS<<EOF" >> $GITHUB_ENV
          echo "$joined_files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV


      - name: å®‰è£…BaiduPCS-Go
        run: |
          curl -LO https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.7/BaiduPCS-Go-v3.9.7-linux-amd64.zip
          unzip BaiduPCS-Go-v3.9.7-linux-amd64.zip
          cd BaiduPCS-Go-v3.9.7-linux-amd64
          chmod +x BaiduPCS-Go
          sudo mv BaiduPCS-Go /usr/local/bin/

      - name: ç™»å½•BaiduPCS-Go
        run: |
          BaiduPCS-Go login -cookies="${{ secrets.BAIDU_COOKIE }}"

      - name: ä¸Šä¼ æ‰€æœ‰é•œåƒåˆ°ç™¾åº¦äº‘ç›˜
        run: |
          echo "${{ env.ASSET_PATHS }}" > files.txt
          echo "ğŸ“ åˆ›å»ºç½‘ç›˜ç›®å½•: /lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º/${{ env.LATEST_VERSION }}"
          BaiduPCS-Go mkdir "/lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º/${{ env.LATEST_VERSION }}"
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "ğŸ“¤ ä¸Šä¼ ä¸­: $file"
              BaiduPCS-Go upload "$file" "/lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º/${{ env.LATEST_VERSION }}"
            else
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done < files.txt

      - name: åˆ›å»º Release
        if: ${{ steps.detect_version.outputs.tag_name != '' }}
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.detect_version.outputs.tag_name }}
          name: ${{ steps.detect_version.outputs.release_name }}
          draft: false
          prerelease: false
          body: |
            ğŸ“¦ ç‰ˆæœ¬å·ï¼š${{ env.LATEST_VERSION }}
            âœ… æ„å»ºæˆåŠŸï¼

          
      - name: è°ƒæ•´é•œåƒå¤§å°ï¼ˆå¦‚æœé•œåƒå¤§äº2Gï¼‰
        id: prepare_release_assets
        run: |
          sudo apt-get update && sudo apt-get install -y p7zip-full
      
          max_size=$((2 * 1024 * 1024 * 1024))
          release_files=""
      
          echo "${{ env.ASSET_PATHS }}" > original_files.txt
      
          while IFS= read -r file; do
            [ ! -f "$file" ] && echo "âŒ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡" && continue
      
            size=$(stat -c%s "$file")
            if (( size > max_size )); then
              echo "ğŸ”§ $file è¶…è¿‡ 2GBï¼Œæ‰§è¡Œåˆ†å·å‹ç¼©"
              base_name=$(basename "$file")
              out_dir=$(dirname "$file")
              split_prefix="${out_dir}/${base_name}.part"
      
              7z a -v1900m -mx=0 "${split_prefix}.7z" "$file"
              for part in "${split_prefix}.7z".*; do
                release_files+="$part"$'\n'
              done
            else
              release_files+="$file"$'\n'
            fi
          done < original_files.txt
      
          echo "RELEASE_ASSETS<<EOF" >> $GITHUB_ENV
          echo "$release_files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      - name: ä¸Šä¼ æ‰€æœ‰é•œåƒåˆ° Release
        if: ${{ env.RELEASE_ASSETS != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${RELEASE_ASSETS}" > upload_list.txt
          echo "ğŸ“¦ å‡†å¤‡ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶åˆ° Releaseï¼š"
          cat upload_list.txt
      
          echo "ğŸ”§ å®‰è£… GitHub CLI..."
          sudo apt-get update
          sudo apt-get install -y gh
      
          echo "ğŸ“¤ å¼€å§‹é€ä¸ªä¸Šä¼ é•œåƒæ–‡ä»¶åˆ° Release..."
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "â¬†ï¸ æ­£åœ¨ä¸Šä¼ : $file"
              gh release upload "${{ steps.detect_version.outputs.tag_name }}" "$file" --clobber --repo "$GITHUB_REPOSITORY" || {
                echo "âŒ ä¸Šä¼ å¤±è´¥ï¼š$file"
              }
            else
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done < upload_list.txt



      - name: å°† .version æ¨é€åˆ° mod-version åˆ†æ”¯
        if: success() && env.LATEST_VERSION != ''
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ‹‰å–è¿œç¨‹ mod-version åˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git fetch origin mod-version || echo "ğŸ†• mod-version åˆ†æ”¯å°šä¸å­˜åœ¨"

          # åˆ‡æ¢æˆ–åˆ›å»ºæœ¬åœ° mod-version ç©ºåˆ†æ”¯ï¼ˆä»…å« .versionï¼‰
          if git rev-parse --verify mod-version >/dev/null 2>&1; then
            git checkout mod-version
          else
            git checkout --orphan mod-version
            git rm -rf .
          fi

          # å†™å…¥å¹¶æäº¤ .version
          echo "${{ env.LATEST_VERSION }}" > .version
          git add .version
          git commit -m "ğŸ”„ ä¿å­˜ç‰ˆæœ¬å· ${{ env.LATEST_VERSION }}" --author="github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

          # å¼ºåˆ¶æ¨é€è‡³è¿œç¨‹ mod-version åˆ†æ”¯
          git push origin mod-version --force

          # åˆ‡å› main
          git checkout main
