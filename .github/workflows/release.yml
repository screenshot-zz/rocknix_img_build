name: å…¨è‡ªåŠ¨é­”æ”¹é•œåƒå‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "æ˜¯å¦å¼ºåˆ¶å¿½ç•¥ç‰ˆæœ¬åˆ¤æ–­å¹¶æ‰§è¡Œæ„å»ºï¼Ÿ"
        required: false
        default: "true"
      manual_tag:
        description: "ï¼ˆå¯é€‰ï¼‰æ‰‹åŠ¨æ„å»ºçš„ tag åï¼ˆå¦‚ 20250722ï¼‰"
        required: false
        default: ""
      selected_archs:
        description: "ï¼ˆå¯é€‰ï¼‰è¦æ„å»ºçš„æ¶æ„ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚ 3566,x55,h700ï¼‰"
        required: false
        default: ""
  schedule:
    - cron: '0 1 * * *'
    - cron: '0 13 * * *'
  create:
    tags:
      - 'v*'

jobs:

  version-check:
    name: ç‰ˆæœ¬æ£€æµ‹ä¸åˆ›å»ºå‘å¸ƒ
    runs-on: ubuntu-latest
    outputs:
      LATEST_VERSION: ${{ steps.detect.outputs.LATEST_VERSION }}
      TAG_NAME:        ${{ steps.detect.outputs.TAG_NAME }}
      RELEASE_NAME:    ${{ steps.detect.outputs.RELEASE_NAME }}
      SKIP_BUILD:      ${{ steps.detect.outputs.SKIP_BUILD }}
      BUILD_ARCHS:     ${{ steps.matrix.outputs.BUILD_ARCHS }}
    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‚ æ¢å¤ä¸Šæ¬¡æ„å»ºç‰ˆæœ¬å·
        run: |
          echo "ğŸ“¥ æ­£åœ¨å°è¯•ä» mod-version åˆ†æ”¯æ¢å¤ .version æ–‡ä»¶..."
          git fetch origin mod-version || echo "âš ï¸ æ— æ³•è·å– mod-version åˆ†æ”¯ï¼Œå¯èƒ½æ˜¯é¦–æ¬¡æ„å»ºã€‚"
          if git show origin/mod-version:.version > .version 2>/dev/null; then
            echo "âœ… æˆåŠŸæ¢å¤ .version æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š"
            cat .version
          else
            echo "ğŸ†• æœªæ£€æµ‹åˆ°å†å²æ„å»ºè®°å½•ï¼Œè§†ä¸ºé¦–æ¬¡æ„å»ºã€‚"
          fi

      - name: ğŸ” è·å–æœ€æ–°ç‰ˆæœ¬å¹¶åˆ¤æ–­æ˜¯å¦è·³è¿‡æ„å»ºï¼ˆå«é‡è¯•ï¼‰
        id: detect
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          retry=0
          max_retry=10

          AUTH_HEADER=""
          if [ -n "$GH_PAT" ]; then
            AUTH_HEADER="Authorization: token $GH_PAT"
            echo "ğŸ” ä½¿ç”¨ GH_PAT æé«˜ API é™é¢"
          else
            echo "âš ï¸ æœªè®¾ç½® GH_PATï¼Œä½¿ç”¨åŒ¿åæ–¹å¼ï¼ˆé™ 60 æ¬¡/å°æ—¶ï¼‰"
          fi

          while [ $retry -lt $max_retry ]; do
            echo "ğŸŒ ç¬¬ $((retry+1)) æ¬¡å°è¯•è·å–ç‰ˆæœ¬å·..."

            resp=$(curl -sSL -H "Accept: application/vnd.github+json" \
              ${AUTH_HEADER:+-H "$AUTH_HEADER"} \
              https://api.github.com/repos/ROCKNIX/distribution-nightly/releases)

            if [[ -z "$resp" || "$resp" == "null" ]]; then
              echo "âš ï¸ è·å–å¤±è´¥ï¼Œ30 ç§’åé‡è¯•..."
            elif echo "$resp" | grep -q "API rate limit exceeded"; then
              echo "â›” GitHub API è®¿é—®é¢‘ç‡å—é™ï¼Œ60 ç§’åé‡è¯•..."
            else
              url=$(echo "$resp" | jq -r '.[0].assets[].browser_download_url' | grep H700 | grep 'img\.gz$' | head -n1)
              echo "ğŸ§ª æå–åˆ°çš„ URL: $url"
              if [ -n "$url" ]; then
                ver=$(basename "$url" | grep -oP '\d{8}')
                if [ -n "$ver" ]; then
                  echo "ğŸ“¦ æœ€æ–°ç‰ˆæœ¬å·ï¼š$ver"
                  echo "LATEST_VERSION=$ver" >> "$GITHUB_OUTPUT"
                  break
                else
                  echo "âŒ æ— æ³•ä» URL ä¸­æå–ç‰ˆæœ¬å·"
                fi
              fi
            fi

            retry=$((retry+1))
            sleep 30
          done

          if [ -z "$ver" ]; then
            echo "âŒ æœ€å¤šé‡è¯• $max_retry æ¬¡ä»æ— æ³•è·å–ç‰ˆæœ¬å·ï¼Œç»ˆæ­¢ã€‚"
            exit 1
          fi

          if [ "${{ github.event.inputs.force_build }}" != "true" ] && [ -f .version ]; then
            old=$(cat .version)
            echo "ğŸ“ ä¸Šæ¬¡æ„å»ºç‰ˆæœ¬ï¼š$old"
            if [ "$old" = "$ver" ]; then
              echo "ğŸŸ¡ å½“å‰ç‰ˆæœ¬æœªæ›´æ–°ï¼Œè·³è¿‡æ„å»º"
              echo "SKIP_BUILD=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          echo "SKIP_BUILD=false" >> "$GITHUB_OUTPUT"

          if [ -n "${{ github.event.inputs.manual_tag }}" ]; then
            echo "TAG_NAME=${{ github.event.inputs.manual_tag }}" >> "$GITHUB_OUTPUT"
            echo "RELEASE_NAME=æ‰‹åŠ¨æ„å»ºæˆåŠŸ - $ver" >> "$GITHUB_OUTPUT"
          else
            echo "TAG_NAME=auto-$ver" >> "$GITHUB_OUTPUT"
            echo "RELEASE_NAME=è‡ªåŠ¨æ„å»ºæˆåŠŸ - $ver" >> "$GITHUB_OUTPUT"
          fi
          
      - name: ğŸ§® è§£æåº”æ„å»ºæ¶æ„ï¼ˆå« miniï¼‰
        id: matrix
        run: |
          if [ -n "${{ github.event.inputs.selected_archs }}" ]; then
            IFS=',' read -ra base <<< "${{ github.event.inputs.selected_archs }}"
          else
            base=("3566" "x55" "3326" "h700")
          fi
      
          result="["
          for arch in "${base[@]}"; do
            result+="\"$arch\",\"${arch}_mini\","
          done
          result="${result%,}]"
      
          echo "âœ… æ„å»ºæ¶æ„çŸ©é˜µï¼š$result"
          echo "BUILD_ARCHS=$result" >> "$GITHUB_OUTPUT"


      - name: è·å–åŒ—äº¬æ—¶é—´ï¼ˆå¯é€‰ï¼‰
        run: |
          echo "BUILD_TIME=$(date -u -d '+8 hour' '+%Y-%m-%d %H:%M:%S')" >> "$GITHUB_ENV"

      - name: ğŸš€ åˆ›å»º GitHub å‘å¸ƒï¼ˆç©ºå‘å¸ƒï¼‰
        if: steps.detect.outputs.SKIP_BUILD != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.detect.outputs.TAG_NAME }}
          name: "[Rocknix é•œåƒæ„å»º] ${{ steps.detect.outputs.LATEST_VERSION }}"
          body: |
            ğŸ‰ æœ¬æ¬¡æ„å»ºæˆåŠŸï¼
      
            - ç‰ˆæœ¬å·: **${{ steps.detect.outputs.LATEST_VERSION }}**
            - ç±»å‹: `${{ steps.detect.outputs.RELEASE_NAME }}`
            - æ„å»ºæ—¶é—´: ${{ env.BUILD_TIME }}
      
            ğŸ“¦ æ„å»ºæ¶æ„: `${{ steps.matrix.outputs.BUILD_ARCHS }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  build-and-upload:
    name: å¹¶è¡Œæ„å»ºä¸ä¸Šä¼ 
    needs: version-check
    if: needs.version-check.outputs.SKIP_BUILD != 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: ${{ fromJson(needs.version-check.outputs.BUILD_ARCHS) }}
  
    steps:
  
      - name: ğŸ§¾ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
  
      - name: ğŸ”§ å®‰è£…æ„å»ºä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet jq p7zip-full gh
  
      - name: ğŸ” å®‰è£…å¹¶ç™»å½• BaiduPCS-Go
        run: |
          curl -Lo pcs.zip https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.7/BaiduPCS-Go-v3.9.7-linux-amd64.zip
          unzip pcs.zip
          mv BaiduPCS-Go-v3.9.7-linux-amd64/BaiduPCS-Go .
          chmod +x BaiduPCS-Go
          sudo mv BaiduPCS-Go /usr/local/bin/
          BaiduPCS-Go login -cookies="${{ secrets.BAIDU_COOKIE }}"
  
      - name: ğŸ”¨ æ„å»ºé•œåƒï¼š${{ matrix.arch }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}  # é¿å…ä½¿ç”¨ GITHUB_TOKENï¼ˆç³»ç»Ÿä¿ç•™ï¼‰
        run: |
          echo "â–¶ï¸ æ‰§è¡Œæ„å»ºï¼šbuild_mod_img.sh ${{ matrix.arch }}"
          chmod +x ./build_mod_img.sh
          sudo GH_PAT="${GH_PAT}" ./build_mod_img.sh ${{ matrix.arch }}
      
                  
        
      - name: â˜ï¸ ä¸Šä¼ åˆ°ç™¾åº¦äº‘ï¼ˆä»…é miniï¼‰
        if: "!endsWith(matrix.arch, '_mini')"  # æ­£ç¡®åˆ¤æ–­æ˜¯å¦ä¸ºé mini
        run: |
          ver=${{ needs.version-check.outputs.LATEST_VERSION }}
          echo "ğŸ“ å½“å‰æ„å»ºæ¶æ„ï¼š${{ matrix.arch }}"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©åˆ—è¡¨ï¼š"
          
          ls -lh *.img.gz || { echo "âŒ æ²¡æœ‰æ‰¾åˆ°æ„å»ºäº§ç‰© *.img.gzï¼Œè·³è¿‡ä¸Šä¼ "; exit 1; }
      
          echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ é mini é•œåƒåˆ°ç™¾åº¦ç½‘ç›˜..."
      
          for f in *.img.gz; do
            if [[ "$f" == *mini* ]]; then
              echo "â© å¿½ç•¥ mini é•œåƒï¼š$f"
            else
              size=$(du -h "$f" | cut -f1)
              echo "ğŸ“¤ ä¸Šä¼ ï¼š$f ï¼ˆå¤§å°ï¼š$sizeï¼‰"
              BaiduPCS-Go upload "$f" "/lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º/$ver"
            fi
          done
      
          echo "âœ… ç™¾åº¦ç½‘ç›˜ä¸Šä¼ å®Œæˆ"

  
      - name: ğŸª“ åˆ†å·å¹¶ä¸Šä¼ è‡³ GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag=${{ needs.version-check.outputs.TAG_NAME }}
          max=$((2*1024*1024*1024))
          for f in *.img.gz; do
            if [ $(stat -c%s "$f") -gt $max ]; then
              echo "ğŸ“ $f è¶…è¿‡ 2GBï¼Œæ‰§è¡Œåˆ†å·..."
              7z a -v1900m -mx=0 "${f}.7z" "$f" && rm -f "$f"
              for part in "${f}.7z".*; do
                echo "â¬†ï¸ ä¸Šä¼ åˆ†å·æ–‡ä»¶ï¼š$part"
                gh release upload "$tag" "$part" --clobber
              done
            else
              echo "â¬†ï¸ ä¸Šä¼ æ–‡ä»¶ï¼š$f"
              gh release upload "$tag" "$f" --clobber
            fi
          done

  save-version:
    name: ä¿å­˜ç‰ˆæœ¬å·
    needs: 
      - version-check
      - build-and-upload
    if: needs.version-check.outputs.SKIP_BUILD != 'true'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” æ‰“å°æ¥è‡ªå‰ä¸€ä¸ª Job çš„ç‰ˆæœ¬å·
        run: echo "ğŸ§¾ æœ€æ–°ç‰ˆæœ¬å·ï¼š${{ needs.version-check.outputs.LATEST_VERSION }}"

      - name: ğŸ’¾ ä¿å­˜å½“å‰ç‰ˆæœ¬å·åˆ° mod-version åˆ†æ”¯
        run: |
          ver="${{ needs.version-check.outputs.LATEST_VERSION }}"
          echo "ğŸ“¥ å†™å…¥å½“å‰ç‰ˆæœ¬å· ver=$ver"

          if [ -z "$ver" ]; then
            echo "âŒ ç‰ˆæœ¬å·ä¸ºç©ºï¼Œç»ˆæ­¢å†™å…¥"
            exit 1
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git fetch origin || true

          if git ls-remote --exit-code --heads origin mod-version >/dev/null; then
            git checkout mod-version
          else
            git checkout --orphan mod-version
            git rm -rf . || true
          fi

          echo "$ver" > .version

          # å¦‚æœå½“å‰å¤„äº orphanï¼ˆé¦–æ¬¡æ„å»ºæ–°åˆ†æ”¯ï¼‰ï¼Œåˆ™å¼ºåˆ¶æäº¤
          if git rev-parse --verify HEAD >/dev/null 2>&1; then
            # HEAD å­˜åœ¨ï¼Œæ­£å¸¸ diff æ£€æŸ¥
            if ! git diff --cached --quiet || ! git diff --quiet; then
              git add .version
              git commit -m "ğŸ”„ ä¿å­˜ç‰ˆæœ¬å· $ver"
              git push origin mod-version --force
            else
              echo "ğŸŸ¢ æ— éœ€æäº¤ï¼Œç‰ˆæœ¬å·æœªå˜æ›´ã€‚"
            fi
          else
            # HEAD ä¸å­˜åœ¨ï¼Œæ˜¯å­¤ç«‹åˆ†æ”¯ï¼Œé¦–æ¬¡æ„å»ºå¿…é¡»æäº¤
            echo "ğŸ†• é¦–æ¬¡æ„å»ºï¼Œå¼ºåˆ¶æäº¤ .version æ–‡ä»¶"
            git add .version
            git commit -m "ğŸ”° åˆå§‹åŒ–ç‰ˆæœ¬å· $ver"
            git push origin mod-version --force
          fi

          
  cleanup-on-failure:
    name: âŒ æ„å»ºå¤±è´¥æ¸…ç†
    if: failure() && needs.version-check.outputs.SKIP_BUILD != 'true'
    needs: 
      - version-check
      - build-and-upload
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ æ¸…ç† Release ä¸ tagï¼ˆä»…æ„å»ºå¤±è´¥æ—¶æ‰§è¡Œï¼‰
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}  # è‡ªå®šä¹‰ tokenï¼Œé¿å…é»˜è®¤ GITHUB_TOKEN æƒé™é™åˆ¶
        run: |
          tag="${{ needs.version-check.outputs.TAG_NAME }}"
          echo "ğŸ” æ£€æµ‹åˆ°å¤±è´¥ï¼Œæ¸…ç† Release å’Œ Tagï¼š$tag"
  
          echo "ğŸ—‘ï¸ åˆ é™¤ Release..."
          gh release delete "$tag" -y || echo "âš ï¸ Release åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"
  
          echo "ğŸ—‘ï¸ åˆ é™¤ Tag..."
          gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" || echo "âš ï¸ Tag åˆ é™¤å¤±è´¥æˆ–ä¸å­˜åœ¨"

