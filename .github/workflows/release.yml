name: Create Release with Image

on:
  create:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬

      # å®‰è£…ä¾èµ–å·¥å…·
      - name: Install xmlstarlet
        run: |
          sudo apt-get update
          sudo apt-get install -y xmlstarlet jq
      - name: Build the 3326 image 
        run: |
          chmod +x ./build_3326_common.sh
          sudo ./build_3326_common.sh mini
          
      - name: Build the h700 image
        run: |
          chmod +x ./build_h700_common.sh
          sudo ./build_h700_common.sh mini
          
      - name: Build the 3566 image
        run: |
          chmod +x ./build_3566_common.sh 
          sudo ./build_3566_common.sh mini
          sudo ./build_3566_common.sh mini x55
      # ä¿®æ­£1ï¼šæ­£ç¡®ç¼©è¿› + ä¿®å¤è·¯å¾„å¤„ç†
      - name: Extract All Image Assets
        id: extract_assets
        run: |
          mapfile -t files < <(find . -type f -name '*.img.gz')
          if [ ${#files[@]} -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ° .img.gz é•œåƒæ–‡ä»¶ï¼"
            exit 1
          fi
          echo "å…±æ‰¾åˆ° ${#files[@]} ä¸ªé•œåƒæ–‡ä»¶ï¼š"
          for f in "${files[@]}"; do
            echo " - $f"
          done
          joined_files=$(printf "%s\n" "${files[@]}")
          echo "ASSET_PATHS<<EOF" >> $GITHUB_ENV
          echo "$joined_files" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      # ä¿®æ­£2ï¼šä½¿ç”¨ç°ä»£releaseåŠ¨ä½œ
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1  # æ›¿ä»£å¼ƒç”¨çš„create-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          name: "Release ${{ github.ref }}"
          draft: false
          prerelease: false

      # ä¿®æ­£3ï¼šæ­£ç¡®å¼•ç”¨ç¯å¢ƒå˜é‡
      - name: Upload All Images as Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ASSET_PATHS }}
      # â¬‡ï¸ å®‰è£… BaiduPCS-Go å·¥å…·
      - name: Install BaiduPCS-Go
        run: |
          curl -LO https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.7/BaiduPCS-Go-v3.9.7-linux-amd64.zip
          unzip BaiduPCS-Go-v3.9.7-linux-amd64.zip
          cd BaiduPCS-Go-v3.9.7-linux-amd64
          chmod +x BaiduPCS-Go
          mv BaiduPCS-Go /usr/local/bin/
      # ğŸ” å®‰å…¨ç™»å½•ç™¾åº¦ç½‘ç›˜ï¼ˆä½¿ç”¨ GitHub Secret ä¸­çš„ Cookieï¼‰
      - name: Login to BaiduPCS-Go
        run: |
          BaiduPCS-Go login -cookies="${{ secrets.BAIDU_COOKIE }}"
      # â˜ï¸ ä¸Šä¼ æ‰€æœ‰é•œåƒæ–‡ä»¶åˆ°ç™¾åº¦ç½‘ç›˜æŒ‡å®šè·¯å¾„
      - name: Upload All Images to Baidu Netdisk
        run: |
          echo "${{ env.ASSET_PATHS }}" > files.txt
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "ğŸ“¤ ä¸Šä¼ ä¸­: $file"
              BaiduPCS-Go upload "$file" "/lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º/"
            else
              echo "âš ï¸ æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done < files.txt
