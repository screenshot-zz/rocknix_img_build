name: ğŸ§¹ æ¸…ç†æ„å»ºè®°å½•ä¸ç™¾åº¦äº‘æ„å»ºç›®å½•

on:
  schedule:
    - cron: "0 4 * * *"
    - cron: "0 16 * * *"
  workflow_dispatch:

jobs:
  cleanup:
    name: ğŸ§¹ è‡ªåŠ¨æ¸…ç†ç™¾åº¦äº‘ä¸ GitHub Releases
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: â˜ï¸ æ¸…ç†ç™¾åº¦äº‘æ„å»ºç›®å½•ï¼ˆnightly & stable å„ä¿ç•™ 5 ä¸ªï¼‰
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ BaiduPCS-Go..."
          curl -Lo pcs.zip https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.7/BaiduPCS-Go-v3.9.7-linux-amd64.zip
          unzip pcs.zip
          mv BaiduPCS-Go-v3.9.7-linux-amd64/BaiduPCS-Go .
          chmod +x BaiduPCS-Go
          sudo mv BaiduPCS-Go /usr/local/bin/

          echo "ğŸ” ä½¿ç”¨ Cookie ç™»å½• BaiduPCS-Go..."
          BaiduPCS-Go login -cookies="${{ secrets.BAIDU_COOKIE }}"

          for TYPE in nightly stable; do
            FOLDER="/lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º/$TYPE"
            echo "ğŸ“‚ æ£€æŸ¥ç›®å½•ï¼š$FOLDER"

            DIRS=$(BaiduPCS-Go ls "$FOLDER" | grep "^d" | awk '{print $2}')
            COUNT=$(echo "$DIRS" | wc -l)

            echo "ğŸ“¦ å½“å‰å­ç›®å½•æ•°é‡ï¼š$COUNT"

            if [ "$COUNT" -gt 5 ]; then
              DELETE_COUNT=$((COUNT - 5))
              echo "ğŸ§¹ [$TYPE] éœ€è¦åˆ é™¤æœ€æ—§çš„ $DELETE_COUNT ä¸ªç›®å½•"

              echo "$DIRS" | sort | head -n "$DELETE_COUNT" | while read dir; do
                echo "âŒ åˆ é™¤ï¼š$FOLDER/$dir"
                BaiduPCS-Go rm -rf "$FOLDER/$dir"
              done
            else
              echo "âœ… [$TYPE] å½“å‰ç›®å½•æ•°é‡æœªè¶…è¿‡é™åˆ¶ï¼Œæ— éœ€æ¸…ç†"
            fi
          done
          
      - name: ğŸ—‘ï¸ æ¸…ç† GitHub Releasesï¼ˆstableã€nightly å„ä¿ç•™5ä¸ªï¼Œå…¶ä½™å…¨éƒ¨åˆ é™¤ + åˆ é™¤å­¤ç«‹ tagï¼‰
        run: |
          echo "ğŸ” è·å–æ‰€æœ‰ Releases..."
          ALL_RELEASES=$(gh release list --limit 100 --json tagName,name --jq '.[] | "\(.tagName):::\(.name)"')
      
          echo "ğŸ” è·å–æ‰€æœ‰ Git Tags..."
          git fetch --tags --force
          ALL_TAGS=$(git tag)
      
          # æå– release ä¸­å·²æœ‰ tag çš„é›†åˆ
          RELEASE_TAGS=$(echo "$ALL_RELEASES" | awk -F ':::' '{print $1}' | sort -u)
          ORPHAN_TAGS=$(comm -23 <(echo "$ALL_TAGS" | sort -u) <(echo "$RELEASE_TAGS"))
      
          echo "ğŸ’£ å­¤ç«‹ tag æ€»æ•°: $(echo "$ORPHAN_TAGS" | grep -c '^' || true)"
          echo "$ORPHAN_TAGS" | while read tag; do
            [ -n "$tag" ] || continue
            echo "âŒ åˆ é™¤å­¤ç«‹ tag: $tag"
            git tag -d "$tag"         2>/dev/null || echo "âš ï¸ æœ¬åœ°ä¸å­˜åœ¨ tagï¼š$tag"
            git push --delete origin "$tag" 2>/dev/null || echo "âš ï¸ è¿œç¨‹ä¸å­˜åœ¨ tagï¼š$tag"
          done
      
          # ========== åŸæœ¬çš„é€»è¾‘ï¼ˆåˆ†ç±»ã€ç»Ÿè®¡ã€æ¸…ç†ï¼‰ ==========
          NIGHTLY_LIST=""
          STABLE_LIST=""
          OTHER_LIST=""
          while IFS=::: read -r tag name; do
            if [ -z "$tag" ] || [ "$tag" = "null" ]; then continue; fi
            [ "$name" = "null" ] && name=""
            if [[ "$tag" =~ [Nn][Ii][Gg][Hh][Tt][Ll][Yy] ]]; then
              NIGHTLY_LIST+="$tag:::$name"$'\n'
            elif [[ "$tag" =~ [Ss][Tt][Aa][Bb][Ll][Ee] ]]; then
              STABLE_LIST+="$tag:::$name"$'\n'
            else
              OTHER_LIST+="$tag:::$name"$'\n'
            fi
          done <<< "$ALL_RELEASES"
      
          # æ‰“å°ç»Ÿè®¡ä¿¡æ¯å‡½æ•°
          print_list_info() {
            local LIST="$1"
            local LABEL="$2"
            local ICON="$3"
            local COUNT=$(echo "$LIST" | grep -v '^\s*$' | wc -l || true)
            echo "ğŸ”¢ [$LABEL] æ€»æ•°: $COUNT"
            if [ "$COUNT" -gt 0 ]; then
              echo "$LIST" | while IFS=::: read -r tag name; do
                [ -z "$tag" ] && continue
                echo "    $ICON $tag â†’ $name"
              done
            fi
          }
      
          print_list_info "$NIGHTLY_LIST" "nightly" "ğŸŒ™"
          print_list_info "$STABLE_LIST"  "stable"  "ğŸŸ¢"
          print_list_info "$OTHER_LIST"   "å…¶ä»–"    "â“"
      
          # é€šç”¨æ¸…ç†å‡½æ•°ï¼ˆä¿ç•™æœ€æ–° N ä¸ªï¼‰
          clean_list_keep() {
            local LIST="$1"
            local LABEL="$2"
            local ICON="$3"
            local KEEP="$4"
            echo "$LIST" | grep -v '^\s*$' | sort -r | tail -n +$((KEEP+1)) | while IFS=::: read -r tag name; do
              echo "ğŸ—‘ï¸ åˆ é™¤ [$LABEL] $tag â†’ $name"
              gh release delete "$tag" -y 2>/dev/null || echo "âš ï¸ æ—  Release å¯åˆ ï¼š$tag"
              gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" || echo "âš ï¸ æ—  tag å¯åˆ ï¼š$tag"
            done
          }
      
          # æ¸…ç† nightly/stableï¼Œä¿ç•™æœ€æ–° 5 ä¸ª
          clean_list_keep "$NIGHTLY_LIST" "nightly" "ğŸŒ™" 5
          clean_list_keep "$STABLE_LIST" "stable" "ğŸŸ¢" 5
      
          # æ¸…ç†æ‰€æœ‰å…¶ä»–ç±»å‹ï¼ˆå…¨éƒ¨åˆ é™¤ï¼‰
          echo "$OTHER_LIST" | grep -v '^\s*$' | while IFS=::: read -r tag name; do
            echo "âŒ åˆ é™¤ [æœªçŸ¥ç±»å‹] $tag â†’ $name"
            gh release delete "$tag" -y 2>/dev/null || echo "âš ï¸ æ—  Release å¯åˆ ï¼š$tag"
            gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$tag" || echo "âš ï¸ æ—  tag å¯åˆ ï¼š$tag"
          done
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}