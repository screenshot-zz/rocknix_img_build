name: ğŸ§¹ æ¸…ç†æ„å»ºè®°å½•ä¸ç™¾åº¦äº‘æ„å»ºç›®å½•

on:
  schedule:
    - cron: "0 4 * * *"    # æ¯å¤©ä¸­åˆ12ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼ŒUTC+8ï¼‰
    - cron: "0 16 * * *"   # æ¯å¤©æ™šä¸Š12ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼ŒUTC+8ï¼‰
  workflow_dispatch:

jobs:
  cleanup:
    name: ğŸ§¹ æ¸…ç†æ„å»ºè®°å½•
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: ğŸ“ æ¸…ç†ç™¾åº¦äº‘æ„å»ºè·¯å¾„ï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰
        run: |
          echo "â¬‡ï¸ ä¸‹è½½ BaiduPCS-Go v3.9.7..."
          curl -Lo pcs.zip https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.7/BaiduPCS-Go-v3.9.7-linux-amd64.zip
          unzip pcs.zip
          mv BaiduPCS-Go-v3.9.7-linux-amd64/BaiduPCS-Go .
          chmod +x BaiduPCS-Go
          sudo mv BaiduPCS-Go /usr/local/bin/

          echo "ğŸ” ä½¿ç”¨ Cookie ç™»å½• BaiduPCS-Go..."
          BaiduPCS-Go login -cookies="${{ secrets.BAIDU_COOKIE }}"

          FOLDER="/lcdykæœ‰çš„æŒæœº/é­”æ”¹åŒ…/rocknixè‡ªåŠ¨æ„å»º"
          echo "ğŸ“‚ æ£€æŸ¥ç›®å½•ï¼š$FOLDER"

          DIRS=$(BaiduPCS-Go ls "$FOLDER" | grep "^d" | awk '{print $2}')
          COUNT=$(echo "$DIRS" | wc -l)

          echo "ğŸ“¦ å½“å‰å­ç›®å½•æ•°é‡ï¼š$COUNT"

          if [ "$COUNT" -gt 10 ]; then
            DELETE_COUNT=$((COUNT - 10))
            echo "ğŸ§¹ éœ€è¦åˆ é™¤æœ€æ—§çš„ $DELETE_COUNT ä¸ªç›®å½•"

            echo "$DIRS" | sort | head -n "$DELETE_COUNT" | while read dir; do
              echo "âŒ åˆ é™¤ï¼š$FOLDER/$dir"
              BaiduPCS-Go rm -rf "$FOLDER/$dir"
            done
          else
            echo "âœ… å½“å‰ç›®å½•æ•°é‡æœªè¶…è¿‡é™åˆ¶ï¼Œæ— éœ€æ¸…ç†"
          fi

      - name: ğŸ”– æ¸…ç† GitHub Releasesï¼ˆä¿ç•™æœ€è¿‘10ä¸ªï¼‰
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 10
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
